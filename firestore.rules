rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 使用者認證檢查
    function isSignedIn() {
      return request.auth != null;
    }
    
    // 取得使用者資料
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // 檢查是否為管理員
    function isAdmin() {
      return isSignedIn() && getUserData().role == 'admin';
    }
    
    // 檢查是否已審核通過
    function isApproved() {
      return isSignedIn() && (getUserData().role == 'admin' || getUserData().role == 'teacher');
    }
    
    // 檢查是否有權限訪問班級
    function hasClassAccess(classId) {
      return isAdmin() || (isApproved() && classId in getUserData().assignedClasses);
    }
    
    // 檢查是否為資料擁有者
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // 使用者集合
    match /users/{userId} {
      // 任何人可以讀取自己的資料
      allow read: if isSignedIn() && request.auth.uid == userId;
      // 管理員可以讀取所有使用者
      allow read: if isAdmin();
      // 使用者可以建立自己的資料
      allow create: if isSignedIn() && request.auth.uid == userId;
      // 管理員可以更新任何使用者
      allow update: if isAdmin();
      // 管理員可以刪除使用者（用於刪除審核申請）
      allow delete: if isAdmin();
      // 使用者可以更新自己的非敏感欄位（包含申請資訊）
      allow update: if isSignedIn() && request.auth.uid == userId 
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['assignedClasses', 'approvedAt', 'approvedBy', 'schoolId'])
                    && (
                      // 允許更新申請資訊（從 pending_info 到 pending_review）
                      (resource.data.role == 'pending_info' && request.resource.data.role == 'pending_review')
                      // 或不改變角色
                      || request.resource.data.role == resource.data.role
                    );
      
      // ===== 使用者隔離的子集合 =====
      
      // 學生資料（使用者隔離）
      match /students/{studentId} {
        // 使用者只能存取自己的學生資料
        allow read, write: if isOwner(userId);
        // 管理員可以讀取所有使用者的學生資料
        allow read: if isAdmin();
        
        // 歷史記錄子集合
        match /history/{historyId} {
          allow read, write: if isOwner(userId);
          allow read: if isAdmin();
        }
      }
      
      // 範本（使用者隔離）
      match /templates/{templateId} {
        allow read, write: if isOwner(userId);
        allow read: if isAdmin();
      }
      
      // 設定（使用者隔離 - 含 API Key，僅本人可存取）
      // ⚠️ 安全考量：管理員也無法讀取，保護 API Key 不被洩漏
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
        // 注意：此處刻意不給管理員讀取權限，保護 API Key
      }
    }

    // 班級集合（全域共用）
    match /classes/{classId} {
      // 已審核使用者可以讀取
      allow read: if isApproved();
      // 只有管理員可以寫入
      allow write: if isAdmin();
    }

    // 學校集合（全域共用）
    match /schools/{schoolId} {
      // 所有登入使用者可以讀取（用於申請表單選擇學校）
      allow read: if isSignedIn();
      // 只有管理員可以寫入
      allow write: if isAdmin();
    }

    // 管理員共享設定集合（API Key 共享功能）
    match /adminConfig/{docId} {
      // 管理員可以完整讀寫
      allow read, write: if isAdmin();
      
      // 已授權的用戶可以讀取（用於取得共享 API Key）
      // 注意：這裡使用信任模式，已授權用戶可以讀取 sharedApiKey
      allow read: if isApproved() 
                  && docId == 'shared'
                  && request.auth.uid in resource.data.authorizedUsers;
    }

    // ===== 舊的全域集合（保留供參考，禁止寫入） =====
    
    // 舊學生集合（已棄用）
    match /students/{studentId} {
      allow read: if isAdmin(); // 僅管理員可讀舊資料
      allow write: if false; // 禁止寫入
      
      match /history/{historyId} {
        allow read: if isAdmin();
        allow write: if false;
      }
    }

    // 舊範本集合（已棄用）
    match /templates/{templateId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // 舊設定集合（已棄用）
    match /settings/{settingId} {
      allow read: if isAdmin();
      allow write: if false;
    }
  }
}
